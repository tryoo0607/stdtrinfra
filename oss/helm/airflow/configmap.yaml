apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-api-server-config
  namespace: insight
data:
  webserver_config.py: |
    from airflow.providers.fab.auth_manager.security_manager.override import FabAirflowSecurityManagerOverride
    from flask import redirect, session, make_response
    from flask_appbuilder import expose
    from flask_appbuilder.security.manager import AUTH_OAUTH
    from flask_appbuilder.security.views import AuthOAuthView
    from jwt import PyJWKClient
    import jwt
    import logging
    import os
    import requests

    log = logging.getLogger(__name__)

    # --------------------
    # Flask / FAB settings
    # --------------------
    CSRF_ENABLED = True
    AUTH_TYPE = AUTH_OAUTH
    AUTH_USER_REGISTRATION = True
    AUTH_ROLES_SYNC_AT_LOGIN = True
    AUTH_USER_REGISTRATION_ROLE = "Public"

    # Airflow session lifetime (초)
    PERMANENT_SESSION_LIFETIME = 900  # 15분

    # --------------------
    # Environment variables
    # --------------------
    CLIENT_ID = os.getenv("CLIENT_ID")
    CLIENT_SECRET = os.getenv("CLIENT_SECRET")
    OIDC_ISSUER = os.getenv("OIDC_ISSUER")
    AIRFLOW__API__BASE_URL = os.getenv("AIRFLOW__API__BASE_URL")

    # --------------------
    # OIDC endpoints
    # --------------------
    OIDC_BASE_URL = f"{OIDC_ISSUER}/protocol/openid-connect"
    OIDC_TOKEN_URL = f"{OIDC_BASE_URL}/token"
    OIDC_AUTH_URL = f"{OIDC_BASE_URL}/auth"
    OIDC_METADATA_URL = f"{OIDC_ISSUER}/.well-known/openid-configuration"

    # --------------------
    # Role mapping
    # --------------------
    AUTH_ROLES_MAPPING = {
        "airflow_admin": ["Admin"],
        "airflow_op": ["Op"],
        "airflow_public": ["Public"],
        "airflow_user": ["User"],
        "airflow_viewer": ["Viewer"],
    }

    # --------------------
    # OAuth provider
    # --------------------
    OAUTH_PROVIDERS = [
        {
            "name": "keycloak",
            "token_key": "access_token",
            "icon": "fa-key",
            "remote_app": {
                "api_base_url": OIDC_BASE_URL,
                "access_token_url": OIDC_TOKEN_URL,
                "authorize_url": OIDC_AUTH_URL,
                "server_metadata_url": OIDC_METADATA_URL,
                "request_token_url": None,
                "client_id": CLIENT_ID,
                "client_secret": CLIENT_SECRET,
                "client_kwargs": {
                    "scope": "openid email profile",
                    "code_challenge_method": "S256",
                    "response_type": "code",
                },
            },
        }
    ]

    # --------------------
    # JWKS (Key rotation 대응)
    # --------------------
    oidc_metadata = requests.get(OIDC_METADATA_URL).json()
    jwks_uri = oidc_metadata["jwks_uri"]
    jwks_client = PyJWKClient(jwks_uri)

    # --------------------
    # Custom logout (Single Logout)
    # --------------------
    class CustomOAuthView(AuthOAuthView):
        @expose("/logout/", methods=["GET", "POST"])
        def logout(self):
            session.clear()

            resp = make_response(
                redirect(
                    f"{OIDC_ISSUER}/protocol/openid-connect/logout"
                    f"?post_logout_redirect_uri={AIRFLOW__API__BASE_URL}"
                    f"&client_id={CLIENT_ID}"
                )
            )

            # Airflow cookies 제거
            resp.delete_cookie("airflow_api_auth")
            resp.delete_cookie("airflow_session")

            return resp

    # --------------------
    # Security Manager
    # --------------------
    class CustomSecurityManager(FabAirflowSecurityManagerOverride):
        authoauthview = CustomOAuthView

        def get_oauth_user_info(self, provider, response):
            if provider != "keycloak":
                return {}

            token = response["access_token"]

            # JWT 검증 (JWKS)
            signing_key = jwks_client.get_signing_key_from_jwt(token)

            me = jwt.decode(
                token,
                signing_key.key,
                algorithms=["RS256"],
                audience=CLIENT_ID,
                options={
                    "verify_exp": True,
                    "verify_aud": True,
                    "verify_signature": True,
                },
            )

            roles = (
                me.get("resource_access", {})
                  .get(CLIENT_ID, {})
                  .get("roles", [])
            )

            if not roles:
                roles = ["Viewer"]

            userinfo = {
                "username": me.get("preferred_username"),
                "email": me.get("email"),
                "first_name": me.get("given_name"),
                "last_name": me.get("family_name"),
                "role_keys": roles,
            }

            log.info(f"Keycloak userinfo: {userinfo}")
            return userinfo

    SECURITY_MANAGER_CLASS = CustomSecurityManager
